language: node_js
node_js:
  - '14'

jobs:
  include:
    - stage: main
      if: branch = main
      name: CI on main branch
      install:
        - yarn install
      script: yarn lint && yarn tsc --noEmit && yarn test --coverage 

    - stage: release
      if: branch =~ /^release\// OR branch =~ /^hotfix\//
      name: CI on release branch
      install:
        - yarn install
      script: yarn lint && yarn tsc --noEmit && yarn test --coverage --changedSince=main
      
    - stage: PR
      if: (NOT branch =~ /^release\//) AND (NOT branch =~ /^hotfix\//) AND (type = pull_request)
      name: CI on Pull Request
      install:
        - yarn install
      script: yarn lint && yarn tsc --noEmit && yarn test --coverage --changedSince=develop
    
    - stage: Develop
      if: branch = develop
      name: CI on develop branch
      install:
        - yarn install
      script: yarn lint && yarn tsc --noEmit && yarn test --coverage --changedSince=main
  
after_success:
  - yarn codecov -t $CODECOV_TOKEN